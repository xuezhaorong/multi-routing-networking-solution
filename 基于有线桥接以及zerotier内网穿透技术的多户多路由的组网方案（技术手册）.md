#  基于有线桥接以及zerotier内网穿透技术的多户多路由的组网方案（技术手册）

​	本方案是为了适应多户使用一条宽带且能远程进行每户路由的独立管理的场景，实际上是在ac+ap组网上进行的改进。在整个的配置技术标准流程中，包括了：**路由物理组线，路由组网配置，主路由的系统刷入和zerotier内网穿透的配置**。

## 基础组网结构

![基础组网结构](https://raw.githubusercontent.com/xuezhaorong/Picgo/main/Source/202401292059438.png)

​	上图灰色部分是由3个路由器组成的3户组网结构，3台路由器处于一个网段，外网通过主路由局域网的内网穿透就可以访问到每一个路由器的后台从而进行管理。

​	由于运营商对光猫的权限限制，黑色部分为宽带报装时的固定部分，不能随便改动，红色部分则为路由物理组线部分，需要进行标准的人工组线。

​	蓝色部分则是软件配置部分，包括路由组网配置，主路由的系统刷入和zerotier内网穿透的配置。

## 路由物理组线（标准）：

​	光猫的**千兆口**连接网线，网线另一头连接到主路由的**wan**口，主路由的两个**lan**口各连接网线连接到两个tp路由器的**lan**口。

## 主路由刷入openwrt（标准）:

​	输入openwrt要先刷入breed，然后进入breed刷入openwrt固件。

主路由信息：

型号：Xiaomi Mi Router 4A Gigabit Edition v2

CPU架构：ramips/mt7621

准备工作：将路由重置为出厂设置，wan口通过网线连接光猫，保证能联网，lan口通过网线与电脑连接，电脑连接热点或者其他wifi，最好有科学上网环境。

1. 通过**ipconfig**命令获取网关地址，在浏览器中输入网关地址进入路由器后台，配置管理员密码，选择自动获取ip上网方式，配置wifi名称和密码并完成设置，等待路由器重启后，此时路由器已经拥有了联网环境。
2. 进入ssh工具包，点击运行**开启tenlent.bat**,按照说明操作，核对并确认好ip地址和管理员密码后运行程序，等待程序运行结束。
3. 点击运行**连接路由器.bat**,通过**putty**软件填入主机名连接路由器，若无响应，则需要关闭这一步的两个窗口，重新第二步的操作再重新进行连接，在putty显示login界面，login和密码都输入root，以下的所有命令操作均在putty内执行。
4. 输入刷机指令进行备份,最后生成16mb的备份固件。

```
cat /proc/mtd&&dd if=/dev/mtd0 
of=/tmp/ALL_backup.bin
```

5. 在浏览器地址栏或电脑计算机的地址栏中输入**ftp://192.168.31.1/tmp/**,进行路由器的文件列表，找到**ALL_backup.bin**文件，下载并保存好（已记录），然后删除原有的**ALL_backup.bin**文件。
6. 把工具包的**breed.bin**文件复制到上述的文件列表内，并通过指令，验证MD5数值看看是否为**24e62762809c15ba3872e610a37451a3**，若不是则停止下面操作，重新本步骤。

```
md5sum /tmp/breed.bin
```

7. 运行刷breed命令，刷入breed，然后输入**reboot**重启路由器，并在浏览器中输入**192.168.1.1**进入breed，在固件备份中，备份编程器固件和eeprom（已记录）。

```
mtd write /tmp/breed.bin Bootloader
```

​	ps:以后进入breed的方法是：路由器断电，按照复位键不放，路由器通电，等5到10秒钟，此时路由器灯为暗紫色，松开复位键，浏览器输入192.168.1.1

8. 刷入固件选择工具包中带zerotier插件的的openwrt固件，eeprom选择刚刚备份的eeprom，最后点击上传，更新，等待路由器刷机完成，此过程中路由器的灯将由闪烁的橙色变为暗紫色，此时刷入openwrt成功。

## 路由组网配置（标准）：

​	由于运营商不允许中继模式，主路由需使用DHCP上网模式，而另外的两个路由的lan口需要设置成和主路由在一个网段下，并且关闭DHCP，防止ip冲突，主路由的DHCP网络地址起始分配基址是从192.168.1.100开始，到192.168.250结束，所以tp路由的lan口地址也要设置在这个范围内。

准备工作：主路由wan口连接光猫，lan口连接电脑，电脑浏览器输入192.168.1.2进入路由后台。

**主路由上网配置**：网络-接口-wan，点击编辑，将协议设置成**DHCP客户端**，切换协议，等待联网即可。联网成功后，到设置向导中设置wifi，此时可以拔掉与电脑连接的网线。

**tp路由上网配置**：路由通电，先不与主路由连接，电脑可以用wifi或者网线连接路由的lan口，进入路由后台。跳过设置向导（可以选择自动获取ip地址的上网选项），更改无线网络名称密码，管理员密码。

1. 重新连接wifi后，进入后台，路由设置-DHCP服务器，关闭DHCP功能，保存，（可能要等待路由重启）。

2. 将tp路由的lan口与主路由的lan口相连接，确保设置上网模式为自动获取ip地址，LAN口设置里将LAN口IP设置模式改为手动，ip地址改为192.168.100~192.168.250区间的一个值（例如192.168.1.111），子网掩码为255.255.255.0，点击保存，设置完成。

## zerotier配置（标准）：

​	设备在刚开始接入zerotier虚拟网时，连接到其他设备的速度较慢，可以多试几次。由于zerotier的根服务器在国外，连接时也可能会出现连接不上的问题，可以过一段时间再连接。 **在不需要接入局域网时，最好关闭zerotier的连接。**

准备工作：到zerotier官网注册账号，并新建一个network，保存网络ID。

1. 进入openwrt后台，VPN-Zerotier插件，填入网络ID，勾选自动允许客户端NAT，启动插件，保存并应用。在zerotier该网络ID下的member中查看是否有设备进入，可以多刷新几次，直至有设备出现，勾选Auth，并标记设备名。
2. 回到openwrt后台，网络-接口-添加新接口，输入名称zerotier，协议为静态地址，接口选择zt开头的接口（每台路由不一样），点击提交。跳转到一般配置，在IPV4地址中填入zerotier给此设备的虚拟ip地址，掩码选择255.255.255.0，防火墙设置中选择lan，保存并应用，等待更改完成。
3. 选择网络-防火墙-自定义规则，粘贴命令,其中**zth6ro3ldk**要换成上述**zt开头接口的名称**，然后在状态-防火墙-打开iptables规则概况中点击重启防火墙。

```
iptables -I FORWARD -i zth6ro3ldk -j ACCEPT
iptables -I FORWARD -o zth6ro3ldk -j ACCEPT
iptables -t nat -I POSTROUTING -o zth6ro3ldk -j MASQUERADE
```

4. 将整个局域网加入到虚拟网之中，回到zerotier的network管理界面复制openwrt的虚拟ip，粘贴到Advanced的via中，在Destination中输入openwrt所在的局域网段，例如：openwrt的实际ip地址为192.168.1.2，虚拟地址为192.168.192.142,则Destination填入192.168.0/24，via中填入192.168.192.142，提交等待路由表更改。完成设置后，局域网内的所有设备据可以被外网访问。

​	ps：异地组网，合并组网需要注意不同局域网内的网段不能相同，如局域网1为192.168.1.0/24，局域网2为192.168.2.0/24

## 整体配置流程（标准）：

1. 先在联网环境下进行openwrt的刷入和配置，以及zerotier的配置和检查。
2. 然后进行tp路由器的组网，在基础组网完成后检查各个路由器的网络连通情况，出现问题可根据维修手册处理，直至各个路由器的网络连通。各个路由器的网络连通均正常后可将网线拔掉，将路由器带到目标场景进行物理组网。
3. **物理组网的规范**：尽量避免网线的折叠和弯曲，做好基础的防护检查和传输性检查，路由器尽量摆放至房屋中心，到房屋的各个角落尽量不超过两堵墙，路由器周围不要有东西阻挡，不要放太高的地方，天线竖直摆放即可，安装过程中注意wan，lan口的区别。

4. 在物理组网完成后，依然需要进行各个路由器的连通性检查，出现问题根据维修手册处理。

​	**连通性检查**：检查各个路由是否能够正常上网，外网是否能访问到各个路由器的后台。

## 问题与改进：

1. openwrt系统在联网上存在偶尔的断流情况。
2. zerotier内网穿透，访问时速度过慢不稳定或者不可访问（加入moon组网改善）。、

## 待测试：

​	1. 理论上tp路由器的lan口也可以接入其他的tp路由器，共同组成一个大的局域网，所以一台主路由器理论上可以连接多台路由器共同组成一个大内网。